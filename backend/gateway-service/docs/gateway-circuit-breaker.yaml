# =================================================================
# 网关熔断配置 - Sentinel Circuit Breaker Configuration
# 服务名称: gateway-service
# 配置组: gateway-service
# 适用于: 所有环境的熔断配置
# =================================================================

# 熔断器总开关
sentinel:
  enabled: true
  transport:
    dashboard: localhost:8080 # Sentinel控制台地址
    port: 8719 # Sentinel客户端端口
  datasource:
    ds1:
      nacos:
        server-addr: localhost:8848
        namespace: d8a0e588-e615-448b-994c-0ad931c56808
        group-id: gateway-service
        data-id: sentinel-degrade-rules
        rule-type: degrade
        data-type: json
    ds2:
      nacos:
        server-addr: localhost:8848
        namespace: d8a0e588-e615-448b-994c-0ad931c56808
        group-id: gateway-service
        data-id: sentinel-flow-rules
        rule-type: flow
        data-type: json

# 熔断降级规则
degrade:
  rules:
    # 用户服务熔断规则
    - resource: user-service
      grade: 1 # 1: 异常比例熔断, 0: 异常数熔断
      count: 0.3 # 30%异常率触发熔断
      timeWindow: 60 # 熔断持续时间60秒
      minRequestAmount: 10 # 最小请求数
      slowRatioThreshold: 0.8 # 慢调用比例80%
      statIntervalMs: 1000 # 统计时长(ms)

    # 交易服务熔断规则
    - resource: trade-service
      grade: 1
      count: 0.5 # 50%异常率触发熔断
      timeWindow: 30 # 熔断持续时间30秒
      minRequestAmount: 5
      slowRatioThreshold: 0.5
      statIntervalMs: 1000

    # 钱包服务熔断规则
    - resource: wallet-service
      grade: 1
      count: 0.2 # 20%异常率触发熔断
      timeWindow: 120 # 熔断持续时间120秒
      minRequestAmount: 3
      slowRatioThreshold: 0.2
      statIntervalMs: 1000

    # 财务服务熔断规则
    - resource: finance-service
      grade: 1
      count: 0.4 # 40%异常率触发熔断
      timeWindow: 60 # 熔断持续时间60秒
      minRequestAmount: 5
      slowRatioThreshold: 0.6
      statIntervalMs: 1000

    # 风控服务熔断规则
    - resource: risk-service
      grade: 1
      count: 0.6 # 60%异常率触发熔断
      timeWindow: 30 # 熔断持续时间30秒
      minRequestAmount: 8
      slowRatioThreshold: 0.7
      statIntervalMs: 1000

# 限流规则
flow:
  rules:
    # 用户服务限流规则
    - resource: user-service
      count: 1000 # QPS阈值
      grade: 1 # QPS模式
      controlBehavior: 0 # 直接拒绝
      burst: 200 # 突发流量
      maxQueueingTimeMs: 0

    # 交易服务限流规则
    - resource: trade-service
      count: 500
      grade: 1
      controlBehavior: 0
      burst: 100
      maxQueueingTimeMs: 0

    # 钱包服务限流规则
    - resource: wallet-service
      count: 200
      grade: 1
      controlBehavior: 0
      burst: 50
      maxQueueingTimeMs: 0

    # 行情服务限流规则
    - resource: market-service
      count: 5000
      grade: 1
      controlBehavior: 1 # 匀速排队
      burst: 1000
      maxQueueingTimeMs: 500

    # 财务服务限流规则
    - resource: finance-service
      count: 300
      grade: 1
      controlBehavior: 0
      burst: 50
      maxQueueingTimeMs: 0

    # 风控服务限流规则
    - resource: risk-service
      count: 800
      grade: 1
      controlBehavior: 0
      burst: 100
      maxQueueingTimeMs: 0

# 系统保护规则
system:
  rules:
    - resource: default
      grade: 0 # CPU使用率
      count: 70 # 70% CPU使用率触发系统保护
      strategy: 0

# 授权规则
authority:
  rules:
    - resource: default
      strategy: 0 # 白名单
      limitApp: gateway-service

# 热点参数限流规则
param-flow:
  rules:
    - resource: user-service
      count: 100
      grade: 1
      paramIdx: 0
      paramFlowItemList:
        - classType: java.lang.String
          count: 50
          object: "admin"

# 熔断降级处理器配置
fallback:
  handlers:
    # 用户服务降级处理器
    - resource: user-service
      class: com.ppcex.gateway.handler.UserFallbackHandler

    # 交易服务降级处理器
    - resource: trade-service
      class: com.ppcex.gateway.handler.TradeFallbackHandler

    # 钱包服务降级处理器
    - resource: wallet-service
      class: com.ppcex.gateway.handler.WalletFallbackHandler

    # 财务服务降级处理器
    - resource: finance-service
      class: com.ppcex.gateway.handler.FinanceFallbackHandler

    # 风控服务降级处理器
    - resource: risk-service
      class: com.ppcex.gateway.handler.RiskFallbackHandler

# 监控配置
metrics:
  enabled: true
  file:
    single:
      size: 10485760 # 10MB
      maxTotalSize: 52428800 # 50MB
      maxFileSize: 5242880 # 5MB
    charset: UTF-8
  log:
    usePid: true
    dir: logs/csp/
    flushIntervalSec: 1

# 日志配置
log:
  switchPid: true
  dir: logs/sentinel/

# 熔断状态监听
listeners:
  enabled: true
  events:
    - DEGRADE
    - FLOW
    - SYSTEM
    - AUTHORITY
    - PARAM_FLOW

# 告警配置
alert:
  enabled: true
  rules:
    - name: "circuit-breaker-open"
      condition: "degrade_grade == 1"
      threshold: 0.5
      duration: 300 # 持续5分钟
      severity: "high"
      message: "服务熔断器已打开，需要立即处理"

    - name: "high-failure-rate"
      condition: "exception_ratio > 0.8"
      duration: 180 # 持续3分钟
      severity: "medium"
      message: "服务失败率过高，可能触发熔断"

    - name: "slow-calls"
      condition: "slow_ratio > 0.6"
      duration: 180
      severity: "medium"
      message: "服务响应缓慢，可能影响用户体验"

# 熔断恢复策略
recovery:
  autoRecovery: true
  checkInterval: 30s
  maxRecoveryAttempts: 3
  waitMultiplier: 2.0

# 健康检查
health:
  enabled: true
  checkInterval: 30s
  timeout: 5s
  endpoints:
    - "/actuator/health"
    - "/api/v1/health"
    - "/health"

# 测试配置
testing:
  enabled: false # 生产环境应该关闭
  endpoints:
    - path: "/api/v1/test/sentinel"
      resource: "test-service"
      count: 10
      grade: 1

# 环境特定配置注释
# =================================================================
# 不同环境需要覆盖的配置示例：
#
# 开发环境 (gateway-circuit-breaker-dev.yaml):
# - 调低熔断阈值便于测试
# - 缩短熔断恢复时间
# - 启用测试模式
#
# 测试环境 (gateway-circuit-breaker-test.yaml):
# - 使用适中的熔断阈值
# - 启用监控功能
# - 简化的告警规则
#
# 生产环境 (gateway-circuit-breaker-prod.yaml):
# - 使用严格的熔断阈值
# - 启用完整的监控和告警
# - 使用较长的熔断恢复时间
# - 启用健康检查
# =================================================================