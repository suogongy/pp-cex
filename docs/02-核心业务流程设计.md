# Web3 CEX 核心业务流程设计

## 1. 概述

本文档详细描述Web3中心化交易所(CEX)的核心业务流程，包括用户注册、交易撮合、资产管理等关键流程。每个流程都配有Mermaid格式的流程图和时序图，以便更好地理解系统各组件之间的交互关系。

## 2. 用户注册与KYC认证流程

### 2.1 业务概述
用户注册是CEX系统的首要入口，包括基本信息注册、邮箱验证、KYC认证等环节，确保用户身份真实性和合规性。

### 2.2 流程图

```mermaid
graph TD
    A[用户访问注册页面] --> B[输入基本信息]
    B --> C[发送验证邮件]
    C --> D[用户点击验证链接]
    D --> E[邮箱验证成功]
    E --> F[设置登录密码]
    F --> G[生成钱包地址]
    G --> H[基础账户创建完成]
    H --> I[开始KYC认证]
    I --> J[上传身份证件]
    J --> K[人工审核/自动审核]
    K --> L{审核通过?}
    L -->|是| M[KYC认证成功]
    L -->|否| N[驳回并说明原因]
    N --> I
    M --> O[账户权限提升]
    O --> P[可以开始交易]

    style A fill:#e1f5fe
    style P fill:#c8e6c9
    style L fill:#fff3e0
```

### 2.3 时序图

```mermaid
sequenceDiagram
    participant U as 用户
    participant F as 前端
    participant G as 网关
    participant US as 用户服务
    participant WS as 钱包服务
    participant EM as 邮件服务
    participant KYC as KYC服务

    U->>F: 访问注册页面
    F->>G: 请求注册页面
    G->>US: 验证访问权限
    US-->>G: 返回注册页面
    G-->>F: 返回注册页面
    F-->>U: 显示注册表单

    U->>F: 填写注册信息
    F->>G: POST /api/auth/register
    G->>US: 注册请求
    US->>US: 验证数据格式
    US->>WS: 生成钱包地址
    WS-->>US: 返回钱包地址
    US->>US: 创建用户记录
    US->>EM: 发送验证邮件
    EM-->>US: 邮件发送成功
    US-->>G: 注册成功响应
    G-->>F: 注册成功
    F-->>U: 提示查收邮件

    U->>F: 点击邮件验证链接
    F->>G: GET /api/auth/verify?token=xxx
    G->>US: 验证邮箱token
    US->>US: 更新用户状态
    US-->>G: 验证成功
    G-->>F: 验证成功
    F-->>U: 跳转设置密码页面

    U->>F: 设置密码
    F->>G: POST /api/auth/set-password
    G->>US: 设置密码
    US->>US: 加密存储密码
    US-->>G: 设置成功
    G-->>F: 设置成功
    F-->>U: 注册完成，提示KYC

    U->>F: 上传KYC资料
    F->>G: POST /api/kyc/submit
    G->>KYC: 提交KYC申请
    KYC->>KYC: 保存KYC资料
    KYC->>KYC: 启动审核流程
    KYC-->>G: 审核中
    G-->>F: 审核中状态
    F-->>U: 显示审核中

    KYC->>KYC: 审核完成
    KYC->>US: 更新用户KYC状态
    KYC->>EM: 发送审核结果邮件
    EM-->>KYC: 邮件发送成功
```

### 2.4 关键设计要点
- **钱包生成**: 使用分层确定性钱包(HD Wallet)为每个用户生成独立的钱包地址
- **安全存储**: 用户密码使用BCrypt加密存储，私钥使用硬件安全模块(HSM)保护
- **KYC流程**: 支持自动审核和人工审核双重机制
- **风控策略**: 在关键节点进行风控检查，防止恶意注册

## 3. 数字资产充值流程

### 3.1 业务概述
用户可以将数字资产充值到CEX平台，包括生成充值地址、区块链确认、资产入账等环节。

### 3.2 流程图

```mermaid
graph TD
    A[用户选择充值币种] --> B[系统生成充值地址]
    B --> C[用户向地址转账]
    C --> D[区块链节点监控]
    D --> E{交易确认数足够?}
    E -->|否| F[等待更多确认]
    F --> D
    E -->|是| G[验证交易有效性]
    G --> H{验证通过?}
    H -->|否| I[标记为可疑交易]
    H -->|是| J[更新用户余额]
    J --> K[记录充值流水]
    K --> L[发送充值通知]
    L --> M[充值完成]

    style A fill:#e1f5fe
    style M fill:#c8e6c9
    style E fill:#fff3e0
    style H fill:#ffebee
```

### 3.3 时序图

```mermaid
sequenceDiagram
    participant U as 用户
    participant F as 前端
    participant G as 网关
    participant WS as 钱包服务
    participant BC as 区块链节点
    participant MS as 消息服务
    participant FS as 财务服务

    U->>F: 选择充值币种
    F->>G: GET /api/wallet/deposit-address?currency=BTC
    G->>WS: 请求充值地址
    WS->>WS: 生成或获取用户地址
    WS-->>G: 返回充值地址
    G-->>F: 返回充值地址
    F-->>U: 显示充值地址和二维码

    U->>BC: 向地址转账
    Note over U,BC: 区块链转账过程

    BC->>WS: 交易通知(通过Webhook)
    WS->>WS: 解析交易数据
    WS->>BC: 验证交易详情
    BC-->>WS: 返回交易确认信息
    WS->>WS: 检查确认数
    WS->>WS: 风控检查

    alt 确认数足够且风控通过
        WS->>WS: 更新用户余额
        WS->>FS: 记录财务流水
        FS-->>WS: 流水记录成功
        WS->>MS: 发送充值通知
        MS-->>WS: 通知发送成功
        WS-->>G: 充值成功
        G-->>F: 充值成功
        F-->>U: 显示充值成功
    else 确认数不足
        WS->>WS: 标记为待确认
        Note over WS: 等待更多区块链确认
    else 风控不通过
        WS->>WS: 标记为可疑交易
        WS->>MS: 发送风控告警
        MS-->>WS: 告警发送成功
    end
```

### 3.4 关键设计要点
- **地址管理**: 为每个用户和币种生成独立的充值地址
- **监控策略**: 根据币种特性设置不同的确认数要求
- **风控检查**: 实时监控大额充值、频繁充值等异常行为
- **通知机制**: 多渠道通知用户充值状态

## 4. 币币交易撮合流程

### 4.1 业务概述
币币交易是CEX的核心功能，包括订单创建、撮合引擎匹配、交易执行、资产结算等环节。

### 4.2 流程图

```mermaid
graph TD
    A[用户创建订单] --> B{订单类型?}
    B -->|限价单| C[检查用户余额]
    B -->|市价单| D[估算成交价格]
    D --> C
    C --> E{余额充足?}
    E -->|否| F[余额不足拒绝]
    E -->|是| G[冻结用户资产]
    G --> H[订单进入撮合引擎]
    H --> I{找到匹配订单?}
    I -->|否| J[订单加入订单簿]
    I -->|是| K[执行撮合逻辑]
    K --> L[计算成交价格]
    L --> M[生成交易记录]
    M --> N[更新买卖双方状态]
    N --> O[资产结算]
    O --> P[发送交易通知]
    P --> Q{订单完全成交?}
    Q -->|否| R[部分成交继续撮合]
    R --> I
    Q -->|是| S[订单完成]
    R --> S

    style A fill:#e1f5fe
    style S fill:#c8e6c9
    style E fill:#fff3e0
    style I fill:#fff3e0
```

### 4.3 时序图

```mermaid
sequenceDiagram
    participant U as 用户
    participant F as 前端
    participant G as 网关
    participant TS as 交易服务
    participant WS as 钱包服务
    participant MS as 撮合服务
    participant FS as 财务服务
    participant NS as 通知服务
    participant RS as 风控服务

    U->>F: 创建交易订单
    F->>G: POST /api/trade/create-order
    G->>TS: 创建订单请求
    TS->>RS: 风控检查
    RS-->>TS: 风控通过
    TS->>WS: 检查并冻结资产
    WS-->>TS: 资产冻结成功
    TS->>TS: 创建订单记录
    TS->>MS: 发送订单到撮合引擎

    MS->>MS: 订单撮合处理
    alt 找到匹配订单
        MS->>MS: 执行撮合逻辑
        MS->>WS: 更新买卖双方资产
        WS-->>MS: 资产更新成功
        MS->>TS: 更新订单状态
        TS->>FS: 记录交易流水
        FS-->>TS: 流水记录成功
        MS->>NS: 发送成交通知
        NS-->>MS: 通知发送成功
    else 无匹配订单
        MS->>MS: 订单加入订单簿
        MS-->>TS: 订单已挂单
    end

    TS-->>G: 订单创建响应
    G-->>F: 订单状态
    F-->>U: 显示订单结果

    Note over MS: 实时推送订单簿更新
    MS->>F: WebSocket推送
    F-->>U: 更新订单簿显示
```

### 4.4 关键设计要点
- **撮合算法**: 采用价格优先、时间优先的原则进行撮合
- **资产冻结**: 下单时立即冻结相应资产，防止余额不足
- **性能优化**: 使用内存数据库和并发队列提升撮合性能
- **实时推送**: 通过WebSocket实时推送订单簿和成交信息

## 5. 资产提现流程

### 5.1 业务概述
用户可以将平台资产提现到外部钱包，包括提现申请、风控审核、区块链转账等环节。

### 5.2 流程图

```mermaid
graph TD
    A[用户申请提现] --> B[验证身份信息]
    B --> C[检查资产余额]
    C --> D{余额充足?}
    D -->|否| E[余额不足拒绝]
    D -->|是| F[计算手续费]
    F --> G[风控检查]
    G --> H{风控通过?}
    H -->|否| I[提现被拒绝]
    H -->|是| J[冻结提现资产]
    J --> K[人工审核/自动审核]
    K --> L{审核通过?}
    L -->|否| M[解冻资产并通知]
    L -->|是| N[构建区块链交易]
    N --> O[发送到区块链网络]
    O --> P{区块链确认?}
    P -->|失败| Q[交易失败处理]
    P -->|成功| R[更新用户余额]
    R --> S[记录提现流水]
    S --> T[发送提现通知]
    T --> U[提现完成]

    style A fill:#e1f5fe
    style U fill:#c8e6c9
    style D fill:#fff3e0
    style H fill:#ffebee
    style L fill:#fff3e0
    style P fill:#fff3e0
```

### 5.3 时序图

```mermaid
sequenceDiagram
    participant U as 用户
    participant F as 前端
    participant G as 网关
    participant WS as 钱包服务
    participant RS as 风控服务
    participant AS as 审核服务
    participant BC as 区块链节点
    participant FS as 财务服务
    participant NS as 通知服务

    U->>F: 申请提现
    F->>G: POST /api/wallet/withdraw
    G->>WS: 提现申请
    WS->>WS: 验证提现信息
    WS->>RS: 风控检查
    RS-->>WS: 风控结果
    WS->>WS: 冻结提现资产
    WS->>AS: 提交审核

    alt 小额自动通过
        AS->>AS: 自动审核通过
    else 大额人工审核
        AS->>AS: 等待人工审核
        Note over AS: 审核员操作
    end

    AS-->>WS: 审核结果
    alt 审核通过
        WS->>BC: 构建并发送交易
        BC->>BC: 区块链确认
        BC-->>WS: 交易哈希

        alt 交易成功
            WS->>WS: 更新用户余额
            WS->>FS: 记录提现流水
            FS-->>WS: 流水记录成功
            WS->>NS: 发送提现通知
            NS-->>WS: 通知发送成功
            WS-->>G: 提现成功
            G-->>F: 提现成功
            F-->>U: 提现成功通知
        else 交易失败
            WS->>WS: 解冻资产
            WS->>NS: 发送失败通知
            NS-->>WS: 通知发送成功
        end
    else 审核拒绝
        WS->>WS: 解冻资产
        WS->>NS: 发送拒绝通知
        NS-->>WS: 通知发送成功
        WS-->>G: 提现拒绝
        G-->>F: 提现拒绝
        F-->>U: 提现拒绝通知
    end
```

### 5.4 关键设计要点
- **审核机制**: 根据提现金额设置不同的审核等级
- **手续费策略**: 动态调整手续费，鼓励区块链网络空闲期提现
- **安全控制**: 多重签名、冷热钱包分离确保资产安全
- **异常处理**: 完善的失败重试和回滚机制

## 6. 订单管理与查询流程

### 6.1 业务概述
用户可以查询历史订单、当前订单，进行订单撤销等操作，系统提供实时订单状态更新。

### 6.2 流程图

```mermaid
graph TD
    A[用户访问订单页面] --> B{操作类型?}
    B -->|查询历史订单| C[查询条件筛选]
    B -->|查询当前订单| D[获取进行中订单]
    B -->|撤销订单| E[验证订单状态]
    C --> F[从数据库查询]
    D --> G[从缓存查询]
    E --> H{订单可撤销?}
    H -->|否| I[撤销失败]
    H -->|是| J[发送撤销请求]
    J --> K[撮合引擎处理]
    K --> L[更新订单状态]
    L --> M[解冻相关资产]
    M --> N[发送撤销通知]
    N --> O[撤销完成]
    F --> P[返回查询结果]
    G --> P

    style A fill:#e1f5fe
    style O fill:#c8e6c9
    style P fill:#c8e6c9
    style H fill:#fff3e0
```

### 6.3 时序图

```mermaid
sequenceDiagram
    participant U as 用户
    participant F as 前端
    participant G as 网关
    participant TS as 交易服务
    participant MS as 撮合服务
    participant WS as 钱包服务
    participant Cache as Redis缓存
    participant DB as 数据库

    U->>F: 查询订单
    F->>G: GET /api/trade/orders
    G->>TS: 查询订单请求
    TS->>Cache: 尝试从缓存获取
    alt 缓存命中
        Cache-->>TS: 返回缓存数据
    else 缓存未命中
        TS->>DB: 从数据库查询
        DB-->>TS: 返回订单数据
        TS->>Cache: 更新缓存
        Cache-->>TS: 缓存更新成功
    end
    TS-->>G: 订单查询结果
    G-->>F: 订单数据
    F-->>U: 显示订单列表

    U->>F: 撤销订单
    F->>G: POST /api/trade/cancel-order
    G->>TS: 撤销订单请求
    TS->>TS: 验证订单状态
    TS->>MS: 发送撤销指令
    MS->>MS: 从订单簿移除
    MS->>WS: 解冻用户资产
    WS-->>MS: 资产解冻成功
    MS->>TS: 撤销完成
    TS->>DB: 更新订单状态
    TS->>Cache: 更新缓存
    Cache-->>TS: 缓存更新成功
    TS-->>G: 撤销成功
    G-->>F: 撤销成功
    F-->>U: 撤销成功通知

    Note over MS: 实时推送订单簿更新
    MS->>F: WebSocket推送
    F-->>U: 更新界面显示
```

### 6.4 关键设计要点
- **缓存策略**: 热点数据缓存，提升查询性能
- **实时更新**: WebSocket实时推送订单状态变化
- **权限控制**: 严格的权限验证，防止越权操作
- **数据一致性**: 确保缓存和数据库数据一致性

## 7. 系统集成与消息流程

### 7.1 业务概述
CEX系统各微服务之间通过RocketMQ进行异步通信，确保系统的高可用性和数据一致性。

### 7.2 消息流程图

```mermaid
graph TD
    A[交易服务] -->|订单创建消息| B[消息队列]
    C[撮合服务] -->|订单匹配消息| B
    D[钱包服务] -->|资产变动消息| B
    E[财务服务] -->|财务流水消息| B
    F[风控服务] -->|风控事件消息| B

    B -->|消息分发| G[交易服务]
    B -->|消息分发| H[撮合服务]
    B -->|消息分发| I[钱包服务]
    B -->|消息分发| J[财务服务]
    B -->|消息分发| K[风控服务]
    B -->|消息分发| L[通知服务]

    style B fill:#e3f2fd
    style G fill:#f3e5f5
    style H fill:#f3e5f5
    style I fill:#f3e5f5
    style J fill:#f3e5f5
    style K fill:#f3e5f5
    style L fill:#f3e5f5
```

### 7.3 消息时序图

```mermaid
sequenceDiagram
    participant TS as 交易服务
    participant MQ as RocketMQ
    participant MS as 撮合服务
    participant WS as 钱包服务
    participant FS as 财务服务
    participant NS as 通知服务

    TS->>MQ: 发送订单创建消息(order-topic)
    MQ->>MQ: 消息持久化
    MQ->>MS: 推送订单消息
    MS->>MS: 处理订单撮合
    MS->>MQ: 发送成交消息(trade-topic)

    MQ->>WS: 推送成交消息
    WS->>WS: 处理资产变动
    WS->>MQ: 发送资产变动消息(asset-topic)

    MQ->>FS: 推送资产变动消息
    FS->>FS: 记录财务流水
    FS->>MQ: 发送流水消息(finance-topic)

    MQ->>NS: 推送通知消息
    NS->>NS: 发送用户通知

    Note over MQ: 消息轨迹记录
    Note over MQ: 事务消息保证一致性
    Note over MQ: 顺序消息保证执行顺序
```

### 7.4 关键设计要点
- **消息可靠性**: 使用事务消息确保消息不丢失
- **顺序保证**: 关键业务消息使用顺序消息
- **消息轨迹**: 完整的消息轨迹追踪和监控
- **幂等性**: 消费者实现幂等性处理，防止重复消费

## 8. 性能监控与告警流程

### 8.1 业务概述
系统通过Prometheus + Grafana实现全方位的性能监控，实时监控系统运行状态并及时告警。

### 8.2 监控流程图

```mermaid
graph TD
    A[各服务埋点] --> B[Prometheus采集]
    C[应用日志] --> D[Logstash收集]
    E[系统指标] --> B
    F[业务指标] --> B

    B --> G[数据存储]
    D --> G

    G --> H[Grafana展示]
    G --> I[AlertManager告警]

    I --> J{达到告警阈值?}
    J -->|是| K[发送告警通知]
    J -->|否| L[继续监控]

    K --> M[邮件通知]
    K --> N[短信通知]
    K --> O[企业微信通知]

    style A fill:#e8f5e8
    style H fill:#e3f2fd
    style I fill:#ffebee
    style K fill:#fff3e0
```

### 8.3 关键监控指标

#### 8.3.1 系统指标
- **CPU使用率**: < 80%
- **内存使用率**: < 85%
- **磁盘使用率**: < 80%
- **网络延迟**: < 100ms

#### 8.3.2 应用指标
- **API响应时间**: < 200ms
- **错误率**: < 1%
- **消息处理延迟**: < 10ms
- **数据库查询时间**: < 50ms

#### 8.3.3 业务指标
- **订单处理量**: 实时监控
- **充值成功率**: > 99%
- **提现处理时间**: < 30分钟
- **用户活跃度**: 实时监控

## 9. 总结

本文档详细描述了Web3 CEX系统的核心业务流程，包括用户注册、资产管理、交易撮合等关键环节。通过Mermaid图表直观展示了各流程的业务逻辑和系统交互，为系统开发和维护提供了清晰的指导。

### 9.1 核心优势
- **高可用性**: 微服务架构支持服务独立扩展和故障隔离
- **高性能**: 撮合引擎内存化处理，支持高并发交易
- **安全性**: 多重安全防护，确保用户资产安全
- **可扩展性**: 模块化设计，支持业务快速迭代

### 9.2 技术特色
- **分布式架构**: 基于Spring Cloud Alibaba的微服务架构
- **消息队列**: RocketMQ保证系统间可靠通信
- **缓存策略**: Redis多级缓存提升系统性能
- **监控告警**: 完善的监控体系确保系统稳定运行

### 9.3 业务特色
- **全流程覆盖**: 从用户注册到资产提现的完整业务闭环
- **实时处理**: 撮合引擎实时处理，保证交易体验
- **风控体系**: 多层次风控确保交易安全
- **用户体验**: 简洁直观的操作流程

通过这些核心流程的设计，系统为用户提供了安全、高效、便捷的数字资产交易服务。