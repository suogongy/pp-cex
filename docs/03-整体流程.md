# Web3 CEX 整体业务流程

## 1. 业务流程概述

### 1.1 核心业务模块

本系统包含以下核心业务模块，各模块之间通过RocketMQ消息队列进行异步通信，保证系统的高可用性和数据一致性：

- **用户服务**: 负责用户注册、登录、KYC认证等用户相关功能
- **交易服务**: 负责订单管理、撮合引擎、行情数据等交易核心功能
- **钱包服务**: 负责用户资产管理、充值提现、资金流水等钱包功能
- **财务服务**: 负责财务管理、风控监控、报表统计等财务功能
- **撮合服务**: 负责订单撮合、成交确认、清算结算等撮合功能

### 1.2 技术架构特点

- **微服务架构**: 基于Spring Cloud Alibaba的微服务架构
- **消息驱动**: 基于RocketMQ的异步消息处理
- **分布式事务**: 通过Seata和RocketMQ事务消息保证数据一致性
- **高可用设计**: 多级缓存、读写分离、熔断降级等高可用策略

## 2. 整体业务流程图

### 2.1 用户注册登录流程

```mermaid
graph TB
    subgraph "用户注册登录流程"
        direction TB
        A[用户访问前端] --> B[选择注册/登录]
        B --> C{注册?}
        C -->|是| D[输入注册信息]
        C -->|否| E[输入登录信息]
        D --> F[发送验证码]
        F --> G[验证码校验]
        G --> H[创建用户信息]
        E --> I[用户身份验证]
        I --> J[生成JWT Token]
        H --> K[生成JWT Token]
        J --> L[返回Token给前端]
        K --> L
        L --> M[用户登录成功]
    end

    style A fill:#e1f5fe
    style M fill:#c8e6c9
```

### 2.2 完整业务流程架构

```mermaid
graph TB
    subgraph "用户访问层"
        direction LR
        ACCESS[用户访问层]
        Web[Web浏览器]
        Mobile[移动App]
        Admin[管理后台]
        API[API客户端]
    end

    subgraph "API网关层"
        direction LR
        GATEWAY[API网关层]
        CoreGateway[Spring Cloud Gateway<br>核心网关]
        Route[路由转发]
        LoadBalance[负载均衡]
        Auth[认证授权]
        CircuitBreaker[限流熔断]
        Nacos[Nacos<br>服务发现]
        Sentinel[Sentinel<br>流量控制]
        Monitor[监控日志]
    end

    subgraph "微服务层"
        direction LR
        SERVICE[微服务层]
        UserService[用户服务<br>User Service]
        TradeService[交易服务<br>Trade Service]
        WalletService[钱包服务<br>Wallet Service]
        FinanceService[财务服务<br>Finance Service]
        MatchService[撮合服务<br>Match Service]
    end

    subgraph "消息队列层"
        direction LR
        MESSAGE[消息队列层]
        Transaction[事务消息]
        Ordered[顺序消息]
        Delayed[延迟消息]
        Broadcast[广播消息]
        Trace[消息轨迹]
    end

    subgraph "数据存储层"
        direction LR
        DATA[数据存储层]
        MySQL[MySQL集群<br>主从复制]
        Redis[Redis集群<br>分布式缓存]
        Elastic[ElasticSearch<br>日志搜索]
    end

    subgraph "区块链层"
        direction LR
        BLOCKCHAIN[区块链层]
        BTCNode[BTC节点<br>比特币网络]
        ETHNode[ETH节点<br>以太坊网络]
        OtherNode[其他链节点<br>多链支持]
        Web3js[Web3.js<br>区块链交互]
    end

    %% 层级关系连接
    ACCESS --> GATEWAY
    GATEWAY --> SERVICE
    SERVICE --> MESSAGE
    MESSAGE --> DATA
    DATA --> BLOCKCHAIN

    %% 样式定义
    classDef accessLayer fill:#e3f2fd,stroke:#1976d2,stroke-width:2px,color:#000
    classDef gatewayLayer fill:#fff3e0,stroke:#f57c00,stroke-width:2px,color:#000
    classDef gatewayCore fill:#ffb74d,stroke:#ef6c00,stroke-width:3px,color:#000,font-weight:bold
    classDef gatewayDependency fill:#ffe0b2,stroke:#f57c00,stroke-width:1px,color:#000
    classDef coreService fill:#ff8a65,stroke:#d84315,stroke-width:3px,color:#000,font-weight:bold
    classDef supportService fill:#81c784,stroke:#2e7d32,stroke-width:3px,color:#000,font-weight:bold
    classDef coreLabel fill:#ffccbc,stroke:#d84315,stroke-width:2px,color:#000,font-weight:bold,font-size:14px
    classDef supportLabel fill:#c8e6c9,stroke:#2e7d32,stroke-width:2px,color:#000,font-weight:bold,font-size:14px
    classDef messageLayer fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#000
    classDef dataLayer fill:#f1f8e9,stroke:#689f38,stroke-width:2px,color:#000
    classDef blockchainLayer fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px,color:#000

    class Web,Mobile,Admin,API accessLayer
    class CoreGateway gatewayCore
    class Route,LoadBalance,Auth,CircuitBreaker gatewayDependency
    class Nacos,Sentinel,Monitor gatewayDependency
    class UserService,TradeService,WalletService coreService
    class FinanceService,MatchService supportService
    class Transaction,Ordered,Delayed messageLayer
    class MySQL,Redis,Elastic dataLayer
    class BTCNode,ETHNode,Web3js blockchainLayer
```

## 3. 核心业务时序图

### 3.1 用户注册时序图

```mermaid
sequenceDiagram
    participant U as 用户
    participant F as 前端
    participant GW as 网关
    participant US as 用户服务
    participant MQ as RocketMQ
    participant DB as MySQL
    participant RD as Redis

    U->>F: 输入注册信息
    F->>GW: POST /api/user/register
    GW->>US: 转发注册请求
    US->>DB: 检查用户是否存在
    DB-->>US: 返回检查结果
    US->>RD: 验证码校验
    RD-->>US: 返回校验结果
    US->>DB: 创建用户记录
    DB-->>US: 返回创建结果
    US->>MQ: 发送用户注册事件
    MQ->>US: 消息确认
    US->>GW: 返回注册成功
    GW->>F: 返回Token
    F-->>U: 显示注册成功
```

### 3.2 充值流程时序图

```mermaid
sequenceDiagram
    participant U as 用户
    participant F as 前端
    participant GW as 网关
    participant WS as 钱包服务
    participant MQ as RocketMQ
    participant BC as 区块链
    participant FS as 财务服务
    participant DB as MySQL

    U->>F: 申请充值
    F->>GW: POST /api/wallet/recharge/apply
    GW->>WS: 转发充值申请
    WS->>DB: 生成充值地址
    DB-->>WS: 返回地址
    WS->>GW: 返回充值地址
    GW->>F: 返回充值地址
    F-->>U: 显示充值地址

    Note over U,BC: 用户向地址转账

    BC->>WS: 区块链通知
    WS->>BC: 确认交易
    BC-->>WS: 返回确认信息
    WS->>MQ: 发送充值确认事务消息
    MQ->>WS: 消息确认
    WS->>DB: 更新用户资产
    DB-->>WS: 返回更新结果

    MQ->>FS: 财务服务消费消息
    FS->>DB: 记录资金流水
    DB-->>FS: 返回记录结果
    FS->>MQ: 消息处理确认

    WS->>GW: 返回充值成功
    GW->>F: 返回成功结果
    F-->>U: 显示充值成功
```

### 3.3 交易下单时序图

```mermaid
sequenceDiagram
    participant U as 用户
    participant F as 前端
    participant GW as 网关
    participant TS as 交易服务
    participant US as 用户服务
    participant MQ as RocketMQ
    participant MS as 撮合服务
    participant WS as 钱包服务
    participant FS as 财务服务
    participant DB as MySQL

    U->>F: 创建订单
    F->>GW: POST /api/trade/order/create
    GW->>TS: 转发订单创建请求
    TS->>US: 验证用户权限
    US-->>TS: 返回验证结果
    TS->>WS: 检查用户资产
    WS-->>TS: 返回资产信息
    TS->>MQ: 发送订单创建事务消息
    MQ->>TS: 消息确认
    TS->>DB: 创建订单记录
    DB-->>TS: 返回创建结果
    TS->>GW: 返回订单创建成功
    GW->>F: 返回成功结果
    F-->>U: 显示订单创建成功

    MQ->>MS: 撮合服务消费消息
    MS->>MQ: 消息确认
    MS->>MS: 订单撮合
    MS->>MQ: 发送撮合结果消息

    MQ->>TS: 交易服务消费结果
    TS->>DB: 更新订单状态
    DB-->>TS: 返回更新结果

    MQ->>WS: 钱包服务消费结果
    WS->>DB: 更新用户资产
    DB-->>WS: 返回更新结果

    MQ->>FS: 财务服务消费结果
    FS->>DB: 记录资金流水
    DB-->>FS: 返回记录结果
```

### 3.4 提现流程时序图

```mermaid
sequenceDiagram
    participant U as 用户
    participant F as 前端
    participant GW as 网关
    participant WS as 钱包服务
    participant US as 用户服务
    participant MQ as RocketMQ
    participant FS as 财务服务
    participant BC as 区块链
    participant DB as MySQL

    U->>F: 申请提现
    F->>GW: POST /api/wallet/withdraw/apply
    GW->>WS: 转发提现申请
    WS->>US: 验证用户权限
    US-->>WS: 返回验证结果
    WS->>DB: 检查用户资产
    DB-->>WS: 返回资产信息
    WS->>MQ: 发送提现申请事务消息
    MQ->>WS: 消息确认
    WS->>DB: 创建提现记录
    DB-->>WS: 返回创建结果
    WS->>GW: 返回提现申请成功
    GW->>F: 返回成功结果
    F-->>U: 显示提现申请成功

    MQ->>FS: 财务服务消费消息
    FS->>DB: 记录资金流水
    DB-->>FS: 返回记录结果

    Note over FS,BC: 人工审核流程

    FS->>MQ: 发送审核通过消息
    MQ->>WS: 钱包服务消费消息
    WS->>DB: 冻结用户资产
    DB-->>WS: 返回冻结结果
    WS->>BC: 发起区块链转账
    BC-->>WS: 返回交易哈希
    WS->>MQ: 发送提现成功消息
    MQ->>FS: 财务服务消费消息
    FS->>DB: 更新提现状态
    DB-->>FS: 返回更新结果
```

## 4. 跨服务通信流程

### 4.1 服务间通信架构

```mermaid
graph TB
    subgraph "服务通信架构"
        direction TB

        subgraph "同步通信层"
            direction LR
            SYNC[同步通信]
            Gateway[API网关<br>Spring Cloud Gateway]
            HTTP[HTTP/REST]
            gRPC[gRPC调用]

            subgraph "核心微服务"
                direction TB
                CoreServices[核心微服务集群]
                US[用户服务<br>User Service]
                TS[交易服务<br>Trade Service]
                WS[钱包服务<br>Wallet Service]
                FS[财务服务<br>Finance Service]
                MS[撮合服务<br>Match Service]
            end
        end

        subgraph "异步通信层"
            direction LR
            RocketMQ[RocketMQ<br>消息队列]

            subgraph "消息类型"
                direction TB
                MsgTypes[消息类型]
                TM[事务消息<br>Transaction Message]
                OM[顺序消息<br>Ordered Message]
                DM[延迟消息<br>Delayed Message]
                BM[广播消息<br>Broadcast Message]
            end
        end

        subgraph "通信模式"
            direction LR

            subgraph "请求-响应"
                direction TB
                RequestResponse[请求-响应模式]
                RR1[同步调用]
                RR2[立即返回]
                RR3[阻塞等待]
            end

            subgraph "发布-订阅"
                direction TB
                PubSub[发布-订阅模式]
                PS1[异步解耦]
                PS2[事件驱动]
                PS3[削峰填谷]
            end
        end
    end

    %% 连接关系
    Gateway --> CoreServices
    CoreServices --> RocketMQ
    RocketMQ --> MsgTypes

    %% 样式定义
    classDef syncLayer fill:#e3f2fd,stroke:#1976d2,stroke-width:2px,color:#000
    classDef asyncLayer fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#000
    classDef patternLayer fill:#e8f5e8,stroke:#388e3c,stroke-width:2px,color:#000
    classDef gatewayCore fill:#ffb74d,stroke:#ef6c00,stroke-width:3px,color:#000,font-weight:bold
    classDef serviceCore fill:#ff8a65,stroke:#d84315,stroke-width:2px,color:#000
    classDef msgType fill:#ce93d8,stroke:#7b1fa2,stroke-width:2px,color:#000
    classDef feature fill:#b39ddb,stroke:#512da8,stroke-width:1px,color:#000

    class Gateway,HTTP,gRPC syncLayer
    class RocketMQ,MsgTypes,Features asyncLayer
    class Patterns,RequestResponse,PubSub patternLayer
    class Gateway gatewayCore
    class US,TS,WS,FS,MS serviceCore
    class TM,OM,DM,BM msgType
    class Reliable,Consistent,Traceable,Scalable feature
```

### 4.2 事件驱动架构

```mermaid
graph TB
    subgraph "事件驱动架构"
        direction TB

        subgraph "事件生产者"
            direction LR
            P1[用户服务事件]
            P2[交易服务事件]
            P3[钱包服务事件]
            P4[撮合服务事件]
            P5[财务服务事件]
        end

        subgraph "事件总线"
            direction LR
            B1[RocketMQ消息队列]
            B2[消息路由策略]
            B3[消息类型管理]
        end

        subgraph "事件消费者"
            direction LR
            C1[核心服务消费组]
            C2[扩展服务消费组]
            C3[事件处理策略]
        end

        subgraph "存储与监控"
            direction LR
            S1[事件存储系统]
            S2[监控告警系统]
            S3[事件追踪系统]
        end
    end

    %% 连接关系
    P1 --> B1
    P2 --> B1
    P3 --> B1
    P4 --> B1
    P5 --> B1

    B1 --> C1
    B1 --> C2
    B1 --> C3

    B1 --> S1
    B1 --> S2
    B1 --> S3

    %% 样式定义
    classDef producer fill:#e3f2fd,stroke:#1976d2,stroke-width:2px,color:#000
    classDef bus fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#000
    classDef consumer fill:#e8f5e8,stroke:#388e3c,stroke-width:2px,color:#000
    classDef storage fill:#fff3e0,stroke:#f57c00,stroke-width:2px,color:#000

    class P1,P2,P3,P4,P5 producer
    class B1,B2,B3 bus
    class C1,C2,C3 consumer
    class S1,S2,S3 storage
```

#### 4.2.1 详细事件类型说明

**用户服务事件**
- 用户注册事件 (UserRegistered)
- 用户登录事件 (UserLoggedIn)
- KYC认证事件 (KYCApproved)
- 用户状态变更 (UserStatusChanged)
- 安全设置变更 (SecurityUpdated)

**交易服务事件**
- 订单创建事件 (OrderCreated)
- 订单成交事件 (OrderFilled)
- 订单取消事件 (OrderCancelled)
- 部分成交事件 (OrderPartiallyFilled)
- 交易手续费事件 (TradeFeeCalculated)

**钱包服务事件**
- 充值确认事件 (DepositConfirmed)
- 提现申请事件 (WithdrawRequested)
- 提现完成事件 (WithdrawCompleted)
- 资产变动事件 (AssetChanged)
- 钱包冻结事件 (WalletFrozen)

**撮合服务事件**
- 撮合成功事件 (MatchSuccess)
- 撮合失败事件 (MatchFailed)
- 深度更新事件 (DepthUpdated)
- 成交价格事件 (TradePriceUpdated)

**财务服务事件**
- 风控触发事件 (RiskTriggered)
- 财务统计事件 (FinanceCalculated)
- 资金流水事件 (FlowRecorded)
- 审计日志事件 (AuditLogged)

#### 4.2.2 事件总线配置

**消息队列管理**
- 用户事件队列 (user-events)
- 交易事件队列 (trade-events)
- 钱包事件队列 (wallet-events)
- 撮合事件队列 (match-events)
- 财务事件队列 (finance-events)
- 系统事件队列 (system-events)

**RocketMQ核心特性**
- 事务消息 (Transactional)
- 顺序消息 (Ordered)
- 延迟消息 (Delayed)
- 广播消息 (Broadcast)

**事件路由策略**
- 广播路由 (Broadcast)
- 定向路由 (Direct)
- 主题路由 (Topic)
- 延迟路由 (Delayed)

#### 4.2.3 事件消费配置

**核心服务消费组**
- 用户服务组 (user-service-group)
- 交易服务组 (trade-service-group)
- 钱包服务组 (wallet-service-group)
- 撮合服务组 (match-service-group)
- 财务服务组 (finance-service-group)

**扩展服务消费组**
- 通知服务组 (notify-service-group)
- 风控服务组 (risk-service-group)
- 报表服务组 (report-service-group)
- 日志服务组 (log-service-group)

**事件处理策略**
- 顺序处理 (Sequential)
- 并行处理 (Parallel)
- 重试机制 (Retry)
- 死信队列 (DLQ)

#### 4.2.4 存储与监控配置

**事件存储**
- 事件数据库 (Event Database)
- 事件日志 (Event Logs)
- 事件快照 (Event Snapshots)

**监控告警**
- 消息堆积监控 (Message Backlog)
- 消费延迟监控 (Consumer Lag)
- 错误率监控 (Error Rate)
- 性能监控 (Performance)

**事件追踪**
- 消息轨迹 (Message Trace)
- 链路追踪 (Link Trace)
- 性能分析 (Performance Analysis)

## 5. 数据一致性保障

### 5.1 分布式事务处理

```mermaid
sequenceDiagram
    participant TS as 交易服务
    participant TM as 事务协调器
    participant MQ as RocketMQ
    participant WS as 钱包服务
    participant FS as 财务服务

    TS->>TM: 开启分布式事务
    TM-->>TS: 返回事务ID
    TS->>DB: 本地数据库操作
    DB-->>TS: 返回操作结果
    TS->>MQ: 发送事务消息
    MQ-->>TS: 消息预提交确认
    TS->>TM: 提交事务
    TM->>MQ: 确认消息提交
    MQ->>WS: 消息投递
    WS->>DB: 本地数据库操作
    DB-->>WS: 返回操作结果
    WS->>MQ: 消息处理确认
    MQ->>FS: 消息投递
    FS->>DB: 本地数据库操作
    DB-->>FS: 返回操作结果
    FS->>MQ: 消息处理确认
```

### 5.2 最终一致性保障

```mermaid
graph TB
    subgraph "最终一致性保障机制"
        direction TB

        subgraph "事务消息"
            direction TB
            A[业务系统] -->|发送事务消息| B[消息队列]
            B -->|预提交| C[业务确认]
            C -->|确认提交| D[消息投递]
        end

        subgraph "补偿机制"
            direction TB
            E[消息重试] -->|重试| F[最大重试次数]
            F -->|超时| G[人工干预]
            E -->|成功| H[业务处理]
        end

        subgraph "监控告警"
            direction TB
            I[消息监控] -->|异常| J[告警系统]
            J -->|通知| K[运维人员]
        end
    end

    style B fill:#f3e5f5
    style G fill:#ffcdd2
    style J fill:#ffcdd2
```

## 6. 容错与降级策略

### 6.1 服务容错机制

```mermaid
graph TB
    subgraph "服务容错机制"
        direction TB

        subgraph "熔断机制"
            direction LR
            A[服务调用] -->|失败率>阈值| B[熔断器开启]
            B -->|快速失败| C[降级处理]
            B -->|半开状态| D[试探性调用]
            D -->|成功| E[熔断器关闭]
        end

        subgraph "限流策略"
            direction LR
            F[请求流量] -->|超过阈值| G[限流拦截]
            G -->|拒绝| H[返回错误]
            F -->|正常| I[正常处理]
        end

        subgraph "降级策略"
            direction LR
            J[核心功能] -->|正常| K[完整功能]
            J -->|异常| L[基础功能]
            J -->|严重| M[只读模式]
        end
    end

    style B fill:#ffcdd2
    style G fill:#ffcdd2
    style M fill:#ffcdd2
```

## 7. 监控与告警

### 7.1 系统监控架构

```mermaid
graph TB
    subgraph "系统监控架构"
        direction TB

        subgraph "服务监控"
            direction LR
            US[用户服务] -->|指标| PM[Prometheus]
            TS[交易服务] -->|指标| PM
            WS[钱包服务] -->|指标| PM
            FS[财务服务] -->|指标| PM
        end

        subgraph "消息监控"
            direction LR
            MQ[RocketMQ] -->|消息指标| PM
            MQ -->|延迟指标| PM
            MQ -->|堆积指标| PM
        end

        subgraph "数据库监控"
            direction LR
            DB[MySQL] -->|性能指标| PM
            RD[Redis] -->|缓存指标| PM
        end

        PM -->|数据采集| GD[Grafana]
        GD -->|可视化| D1[仪表盘]
        GD -->|告警| AM[AlertManager]
        AM -->|通知| N[通知系统]
    end

    style PM fill:#fff3e0
    style GD fill:#e8f5e8
    style AM fill:#ffcdd2
```

## 8. 总结

### 8.1 核心特点

1. **高可用性**: 通过微服务架构、熔断降级、多级缓存等机制保证系统高可用
2. **高性能**: 采用异步消息处理、读写分离、缓存策略等提升系统性能
3. **一致性**: 通过分布式事务、事务消息、补偿机制等保证数据一致性
4. **可扩展性**: 微服务架构支持水平扩展，消息队列支持异步处理
5. **安全性**: 多重安全机制，包括身份认证、权限控制、数据加密等

### 8.2 技术选型理由

1. **Spring Cloud Alibaba**: 成熟的微服务框架，提供服务注册、配置管理、熔断限流等功能
2. **RocketMQ**: 金融级消息队列，支持事务消息、顺序消息、延迟消息等特性
3. **Redis**: 高性能缓存，提供会话管理、热点数据缓存等功能
4. **MySQL**: 成熟的关系型数据库，支持事务、索引、主从复制等特性
5. **区块链集成**: 支持多链接入，提供真实的数字资产交易体验

### 8.3 业务流程优化

1. **异步处理**: 通过消息队列实现业务解耦，提升系统吞吐量
2. **最终一致性**: 采用最终一致性模型，在保证数据一致性的同时提升系统性能
3. **容错设计**: 通过熔断降级、重试机制等保证系统稳定性
4. **监控告警**: 完善的监控体系，及时发现和处理系统异常

通过以上整体流程设计，系统可以实现高效、稳定、安全的数字资产交易服务，为用户提供优质的交易体验。