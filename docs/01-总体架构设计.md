# Web3 CEX 系统总体架构设计

## 1. 架构概述

### 1.1 设计目标
- **高可用性**: 99.9%系统可用性
- **高性能**: 订单处理延迟<100ms，支持10,000+并发用户
- **高扩展性**: 微服务架构，支持水平扩展
- **安全性**: 金融级安全保障，资产零丢失
- **一致性**: 分布式事务保证数据一致性

### 1.2 架构原则
- **微服务化**: 按业务边界划分服务
- **无状态设计**: 服务实例无状态，支持弹性扩展
- **异步通信**: 基于RocketMQ的异步消息处理
- **读写分离**: 数据库读写分离，提升查询性能
- **缓存优先**: 多级缓存策略，提升响应速度

## 2. 系统架构图

### 2.1 整体架构
```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                  用户访问层                                       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │  Web浏览器   │  │  移动App    │  │  管理后台    │  │  API客户端   │             │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘             │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                  CDN/WAF层                                       │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │            CDN加速 + DDoS防护 + Web应用防火墙                               │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                  API网关层                                       │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │              Spring Cloud Gateway + Nacos + Sentinel                       │ │
│  │  路由转发 │ 负载均衡 │ 限流熔断 │ 认证授权 │ 监控日志                     │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                  微服务层                                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │ 用户服务     │  │ 交易服务     │  │ 钱包服务     │  │ 财务服务     │             │
│  │User Service │  │Trade Service│  │Wallet Service│  │Finance Service│            │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │ 行情服务     │  │ 风控服务     │  │ 通知服务     │  │ 撮合服务     │             │
│  │Market Service│ │Risk Service │ │Notify Service│ │Match Service │             │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘             │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                  消息队列层                                       │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                           RocketMQ 4.9.x                                    │ │
│  │  事务消息 │ 顺序消息 │ 延迟消息 │ 广播消息 │ 消息轨迹                        │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                  缓存层                                           │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                              Redis 7.x                                       │ │
│  │  分布式缓存 │ 本地缓存 │ 会话管理 │ 分布式锁 │ 计数器                       │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                  数据存储层                                       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │  主数据库    │  │  从数据库    │  │  时序数据库  │  │  文件存储    │             │
│  │ MySQL Master│  │ MySQL Slave │  │ InfluxDB    │  │ MinIO       │             │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘             │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                  基础设施层                                       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │ 服务注册     │  │ 配置中心     │  │ 监控告警     │  │ 日志收集     │             │
│  │   Nacos     │  │ Nacos Config│ │Prometheus+Grafana│  ELK Stack   │             │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘             │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 3. 微服务拆分设计

### 3.1 服务划分

| 服务名称 | 职责 | 端口 | 依赖 |
|---------|------|------|------|
| user-service | 用户管理、认证授权、KYC | 8001 | Redis、MySQL |
| trade-service | 交易管理、订单处理 | 8002 | Redis、MySQL、RocketMQ |
| wallet-service | 钱包管理、资产变动 | 8003 | Redis、MySQL、RocketMQ |
| finance-service | 财务管理、统计报表 | 8004 | Redis、MySQL、RocketMQ |
| market-service | 行情数据、K线图 | 8005 | Redis、MySQL、WebSocket |
| risk-service | 风控管理、规则引擎 | 8006 | Redis、MySQL、RocketMQ |
| notify-service | 消息通知、推送服务 | 8007 | Redis、RocketMQ |
| match-service | 撮合引擎、订单匹配 | 8008 | Redis、RocketMQ |
| gateway-service | API网关、路由转发 | 9000 | Nacos、Sentinel |

### 3.2 服务间通信

#### 3.2.1 同步通信
- **HTTP/REST**: 服务间API调用
- **OpenFeign**: 声明式HTTP客户端
- **负载均衡**: Ribbon + Nacos

#### 3.2.2 异步通信
- **RocketMQ**: 核心业务消息
- **消息 Topic 规划**:
  - `order-topic`: 订单相关消息
  - `asset-topic`: 资产变动消息
  - `trade-topic`: 交易相关消息
  - `notify-topic`: 通知消息
  - `risk-topic`: 风控消息

## 4. 核心技术组件

### 4.1 服务治理
- **服务注册发现**: Nacos 2.2.x
- **配置管理**: Nacos Config
- **服务网关**: Spring Cloud Gateway
- **熔断限流**: Sentinel
- **分布式事务**: Seata

### 4.2 消息队列
- **消息中间件**: RocketMQ 4.9.x
- **消息模式**: 集群模式
- **消息可靠性**: 同步刷盘 + 消息持久化
- **消息顺序**: 顺序消息保证
- **事务消息**: 分布式事务支持

### 4.3 数据存储
- **主数据库**: MySQL 8.0 Master
- **从数据库**: MySQL 8.0 Slave (读写分离)
- **缓存**: Redis 7.x Cluster
- **时序数据**: InfluxDB (行情数据)
- **文件存储**: MinIO (用户文件、日志)

### 4.4 监控运维
- **监控**: Prometheus + Grafana
- **日志**: ELK Stack (Elasticsearch + Logstash + Kibana)
- **链路追踪**: SkyWalking
- **告警**: AlertManager

## 5. 关键技术设计

### 5.1 高并发设计
- **无状态服务**: 服务实例无状态，支持水平扩展
- **连接池**: 数据库连接池、HTTP连接池
- **异步处理**: RocketMQ异步消息处理
- **缓存策略**: 多级缓存 + 缓存预热

### 5.2 数据一致性
- **分布式事务**: Seata AT模式 + RocketMQ事务消息
- **最终一致性**: 异步消息保证数据最终一致
- **幂等性设计**: 防止重复处理
- **数据校验**: 应用层 + 数据层双重校验

### 5.3 安全设计
- **认证授权**: JWT + OAuth2
- **数据加密**: 传输加密 + 存储加密
- **访问控制**: RBAC权限控制
- **安全审计**: 操作日志记录

## 6. 性能指标

### 6.1 系统性能
- **订单处理延迟**: < 100ms
- **消息处理延迟**: < 10ms
- **API响应时间**: < 200ms
- **并发用户数**: 10,000+
- **系统可用性**: 99.9%

### 6.2 业务性能
- **日交易量**: 100万笔
- **消息吞吐量**: 单机10万+ TPS
- **缓存命中率**: > 90%
- **数据库QPS**: 主库5000，从库10000

## 7. 扩展性设计

### 7.1 水平扩展
- **服务扩展**: 微服务支持独立扩展
- **数据库扩展**: 读写分离 + 分库分表
- **缓存扩展**: Redis Cluster
- **消息队列扩展**: Broker集群

### 7.2 垂直扩展
- **硬件升级**: 服务器配置升级
- **性能优化**: JVM调优、SQL优化
- **架构优化**: 缓存策略、异步处理

## 8. 容灾设计

### 8.1 故障恢复
- **服务容错**: 熔断降级 + 重试机制
- **数据备份**: 定时备份 + 实时同步
- **故障转移**: 自动故障转移 + 手动干预

### 8.2 灾难恢复
- **多活部署**: 跨机房部署
- **数据容灾**: 异地备份
- **业务容灾**: 核心业务降级方案